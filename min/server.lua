dofile("updateCache.lua")dofile("decode_ws.lua")dofile("encode_ws.lua")local function a(b)return crypto.toBase64(crypto.sha1(b.."258EAFA5-E914-47DA-95CA-C5AB0DC85B11"))end;local function c(d)return crypto.toHex(crypto.sha1(d.hash..d.time..node.random(100)))end;local function e(f,d)f:send(encode(sjson.encode({ssn=0,rld=1}),0x1))tmr.alarm(3,d,tmr.ALARM_SINGLE,function()node.restart()end)end;function server(g)srv=net.createServer(net.TCP):listen(80,function(h)local i,j,k,b,l,m;local n,o={},1;h:on("receive",function(f,p)if l then dofile("errors.lua")l=l..p;while true do i,j,k=decode(l)if not i then break end;l=i;if j then m=sjson.decode(j)end;if not m.ssn and k==1 then local q=readFile(g.pwdc)if q then if tostring(crypto.toHex(crypto.sha1(m.hash)))==tostring(sjson.decode(q).pass)then m.ssn=c(m)m.hash=1;writeFile(g.ssnc,m)m.time=1;m.ssnDrtn=g.ssnDrtn;f:send(encode(sjson.encode(m),0x1))else dofile("messenger.lua")msg(f,eAuth,0x1)end else dofile("messenger.lua")msg(f,eiAuth,0x1)end;q=nil end;if k==8 then srv=nil;collectgarbage()elseif m.ssn then local rf=readFile(g.ssnc)if rf then local r=sjson.decode(rf)if m.ssn==r.ssn and m.time<=r.time+g.ssnDrtn*86400000 then if k==1 then if m.newhash then writeFile(g.pwdc,{pass=crypto.toHex(crypto.sha1(m.newhash))})writeFile(g.ssnc,{ssn=0})e(f,100)elseif m.ssid and m.pass then writeFile(g.apc,{ssid=m.ssid,pwd=m.pass})else local tbd=updateCache(g.c,sD,'trh',j)if tbd then f:send(encode(tbd,0x1))else dofile("messenger.lua")msg(f,e2,0x1)end;if not tmr.state(1)then tmr.alarm(1,g.prd,tmr.ALARM_AUTO,function()if n.dp~=sD.dp or n.rt~=sD.rt then n.dp=sD.dp;n.rt=sD.rt;tbd=updateCache(g.c,sD)if tbd then f:send(encode(tbd,0x1))else dofile("messenger.lua")msg(f,e2,0x1)end end end)end end elseif k==9 then dofile("pingpong.lua")pong(f,j,0xA)end else dofile("messenger.lua")msg(f,eAuth,0x1)end else e(f,100)end end end;i,j,k,tbd,rf=nil,nil,nil,nil,nil end;local s,t,u,v,w;_,s,t,u=p:find("([A-Z]+) /([^?]*)%??(.*) HTTP/%d%.%d\r\n")if u==""then u="index.html"end;while s do _,s,v,w=p:find("([^ ]+): *([^\r]+)\r\n",s+1)if not s then break end;if string.lower(v)=="sec-websocket-key"then b=w end end;if t=="GET"and b then f:send("HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: "..a(b).."\r\n\r\n")l=''end;if u and not b then dofile("server_s.lua")if o==1 then pageHandler(f,u,g.cDrtn)o=o+1 else o=o+1;tmr.delay(o*1100)pageHandler(f,u,g.cDrtn)end end end)h:on("sent",function(f)if not b then f:close()end end)end)e500=nil;node.egc.setmode(node.egc.ALWAYS)end
