function encode(a,b)node.egc.setmode(node.egc.ALWAYS)local c=bit.band;local d=bit.rshift;local e=bit.bor;local f=string.char;b=b or 2;assert(type(b)=="number","opcode must be number")assert(type(a)=="string","payload must be string")local g=#a;local h=f(e(0x80,b),g<126 and g or g<0x10000 and 126 or 127)if g>=0x10000 then h=h..f(0,0,0,0,c(d(g,24),0xff),c(d(g,16),0xff),c(d(g,8),0xff),c(g,0xff))elseif g>=126 then h=h..f(c(d(g,8),0xff),c(g,0xff))end;return h..a end
